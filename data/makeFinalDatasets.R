#### Script to generate needed datasets
##
## Outputs:
## - geojson of PCs with their financial vulnerability index for the most recent quarter
## - geojson of regions with their financial vulnerability index for the most recent quarter
## - mapping of postal codes to PCs and regions
## - mapping of PCs, regions, and the UK to their financial vulnerability index and component values
##
#########################################

library(tidyverse)
library(readxl)
library(sf)
library(janitor)
library(lubridate)

# set date of most recent quarter of data
most_recent <- ymd("2020-04-01")

# read in shapefiles of PC and region boundaries
pc_shp <- st_read("shapefiles/parliamentary_constituencies/uk_shape.shp")
pc_shp  # projection is WGS 84 / Pseudo-Mercator

# st_crs(pc_shp)

region_shp <- st_read("shapefiles/regions/uk_region.shp")
region_shp # projection is OSGB 1936 / British National Grid

# st_crs(region_shp)

# read in data
pc_data <- read_excel("source/UK_Index_PCs.xls") %>%
  clean_names() %>%
  mutate(geo = "PC") %>%
  rename("geo_name" = parliamentary_constituency)

# bin the values into low, low/medium, medium/high, high, and very high buckets
pc_data <- pc_data %>%
  mutate(distress_level = case_when(
    financial_vulnerability_index <= 30 ~ "low",
    financial_vulnerability_index > 30 & financial_vulnerability_index <= 40 ~ "low/medium",
    financial_vulnerability_index > 40 & financial_vulnerability_index <= 50 ~ "medium/high",
    financial_vulnerability_index > 50 & financial_vulnerability_index <= 65 ~ "high",
    financial_vulnerability_index > 65 ~ "very high"
  ))

pc_data$distress_level <- factor(pc_data$distress_level, 
                              levels = c("low", "low/medium", "medium/high", "high", "very high"))

# round the financial vulnerability index to one decimal place and 
# the component values to two decimal places
pc_data <- pc_data %>%
  mutate(financial_vulnerability_index = round(financial_vulnerability_index, digits = 1),
         share_of_lowell_consumers_in_default = round(share_of_lowell_consumers_in_default, digits = 2),
         share_claiming_social_benefits = round(share_claiming_social_benefits, digits = 2),
         share_with_subprime_lending = round(share_with_subprime_lending, digits = 2),
         average_credit_use = round(average_credit_use, digits = 2))

# convert quarter and year into a date that can be used for time axis
pc_data <- pc_data %>%
  mutate(month = case_when(
    quarter == "Q1" ~ 1,
    quarter == "Q2" ~ 4,
    quarter == "Q3" ~ 7,
    quarter == "Q4" ~ 10
  ),
  date = make_date(year, month, 1)) %>%
  select(-month)

# export data
write_csv(pc_data, "index_data.csv")

### MAKE GEOJSONS

# merge financial vulnerability index data for the most recent quarter onto shapefile (this produces a tibble)
pc_merged <- pc_data %>%
  filter(date == most_recent,
         geo == "PC") %>%
  select(pc_code, geo_name, financial_vulnerability_index) %>%
  right_join(pc_shp, by = c("pc_code" = "PCON17CD")) %>%
  select(-geo_name)

# convert merged tibble back into a spatial dataframe (need to do this so we can reproject the data)
pc_merged_sf <- st_as_sf(pc_merged)

# reproject regions spatial dataframe to WGS84 (needed for Mapbox)
# pc_merged_wgs <- st_transform(pc_merged_sf, 4326)

# export merged dataset as a geojson file
st_write(pc_merged_sf, "pcs.geojson", delete_dsn = T)
